from metal.layers.conv2D_ import Conv2D
import unittest
from autograd.tensor import Tensor
from autograd.parameter import Parameter
import numpy as np


true_c3out = np.array([[[[-0.79899037,  1.0320021 ,  0.23549885],
         [ 0.2674513 ,  0.9715072 ,  0.53558135],
         [ 0.3240632 , -0.00254381,  0.33129525]],

        [[-0.21604921,  0.48240322, -0.00326236],
         [-0.6017107 , -1.1812458 ,  0.16737139],
         [-0.72112125, -0.40808514, -0.32228673]]],


       [[[-0.4251591 ,  0.683436  , -0.24868044],
         [-0.33330798,  0.0398453 ,  0.18328846],
         [ 0.49960458,  0.35438943, -0.51435834]],

        [[ 1.5021229 , -0.7569632 , -0.32508022],
         [ 1.0651203 , -0.80910695, -0.24125695],
         [ 0.4442642 ,  0.83503157,  0.17313306]]]], dtype=np.float32)

true_c3_wgrad = np.array([[[[-8.1958604e-01,  1.0208690e+00,  3.9241052e+00],
         [ 3.4484870e+00,  4.5810738e+00,  2.3273344e+00],
         [ 5.8616867e+00,  4.3492393e+00,  1.8755645e-01]],

        [[-4.7801805e+00, -2.7115669e+00,  4.2835480e-01],
         [-2.1021600e+00, -6.9031024e-01, -3.4040734e-01],
         [ 1.9431865e+00,  1.1405821e+00, -4.0054804e-01]],

        [[-2.8902912e+00, -2.5936840e+00, -2.2892189e-01],
         [-3.3284969e+00, -4.3632760e+00, -3.2161059e+00],
         [-2.0851419e+00, -3.9394836e+00, -3.9506602e+00]]],


       [[[ 1.4981157e-01, -2.1309835e-01,  1.1286311e+00],
         [ 8.9213133e-01,  1.3016343e-01,  1.6438137e+00],
         [ 2.5715911e+00,  2.2869923e+00,  9.8998535e-01]],

        [[-1.4619792e+00, -1.4489021e+00, -3.7366119e-01],
         [-2.2912297e+00, -2.3602426e+00, -3.8332206e-01],
         [ 2.4895072e-03,  6.7994034e-01,  7.1455872e-01]],

        [[-1.3030703e+00, -8.7643850e-01,  2.2417545e-02],
         [-2.0311875e+00, -2.2784538e+00, -6.2821221e-01],
         [-7.8747094e-01, -1.9742014e+00, -2.1652365e+00]]]],
      dtype=np.float32)

true_c3_bgrad = np.array([[-20.11926958],
       [ -9.58107759]])
true_c4_bgrad = np.array([[18.],
       [18.]])
true_c4_wgrad = np.array([[[[ 1.43678437,  2.14247261,  3.43247878],
         [ 2.61229777,  3.13492292,  3.60126132],
         [ 2.1210093 ,  2.65681599,  1.8990049 ]],

        [[-0.5154294 , -0.91765755, -2.66714081],
         [-0.36534001, -0.91672178, -2.389348  ],
         [-1.3768536 , -1.59989276, -1.78644551]]],


       [[[ 1.43678437,  2.14247261,  3.43247878],
         [ 2.61229777,  3.13492292,  3.60126132],
         [ 2.1210093 ,  2.65681599,  1.8990049 ]],

        [[-0.5154294 , -0.91765755, -2.66714081],
         [-0.36534001, -0.91672178, -2.389348  ],
         [-1.3768536 , -1.59989276, -1.78644551]]]])




true_c4out = np.array([[[[-0.42370066, -0.43009187, -0.50845811],
         [ 0.25508575, -0.575298  , -0.10159585],
         [-0.06149733, -0.11085947,  0.06543428]],

        [[-0.22442041, -0.08442765, -0.51309691],
         [ 0.00406582, -0.6208603 , -0.24300702],
         [ 0.24924928,  0.03614051,  0.41039784]]],


       [[[ 0.34074468, -0.23730474, -0.03891834],
         [ 0.55066421, -0.45215798,  0.41334732],
         [-0.06129876, -0.34717051, -0.14316889]],

        [[-0.4970375 ,  0.30046468, -0.09504793],
         [-0.45896246, -0.37225861,  0.40149224],
         [-0.15349387, -0.37440159,  0.08442678]]]])

true_c3back = np.array([[[[ 1.03304266,  0.86942988,  0.52080743],
         [ 0.99516422,  1.37313643,  1.16460699],
         [ 0.83144443,  1.13726439,  0.7903138 ]],

        [[-0.70701887, -0.57932473, -0.20696652],
         [-0.39403503, -0.34673656,  0.14282782],
         [-0.0811552 , -0.15464339,  0.35380414]],

        [[ 0.68105897,  0.67337833,  0.38279948],
         [-0.14655006,  0.35528163,  0.43895762],
         [-1.06002084, -0.28564495,  0.38266378]]],


       [[[ 1.03304266,  0.86942988,  0.52080743],
         [ 0.99516422,  1.37313643,  1.16460699],
         [ 0.83144443,  1.13726439,  0.7903138 ]],

        [[-0.70701887, -0.57932473, -0.20696652],
         [-0.39403503, -0.34673656,  0.14282782],
         [-0.0811552 , -0.15464339,  0.35380414]],

        [[ 0.68105897,  0.67337833,  0.38279948],
         [-0.14655006,  0.35528163,  0.43895762],
         [-1.06002084, -0.28564495,  0.38266378]]]])

true_c4back = np.array([[[[-0.84184858, -1.18733238, -1.0427759 ],
         [-1.14329866, -1.80500468, -1.21498727],
         [-0.73538406, -1.43369579, -0.65530746]],

        [[-0.97806548, -1.17552217, -0.49294909],
         [-0.55965415, -0.83635785, -0.33272143],
         [-0.03646282, -0.23247876, -0.14632704]]],


       [[[-0.84184858, -1.18733238, -1.0427759 ],
         [-1.14329866, -1.80500468, -1.21498727],
         [-0.73538406, -1.43369579, -0.65530746]],

        [[-0.97806548, -1.17552217, -0.49294909],
         [-0.55965415, -0.83635785, -0.33272143],
         [-0.03646282, -0.23247876, -0.14632704]]]])

class TestLayerConv2d(unittest.TestCase):
    def test_conv2d_f(self):

        c3=Conv2D(n_filters=2, filter_shape=(3,3), stride=1, input_shape=(3,3,3), padding='same',seed=1)
        c4=Conv2D(n_filters=2, filter_shape=(3,3), stride=1,input_shape=c3.output_shape(), padding='same',seed=2)
        c3.initialize()
        c4.initialize()

        np.random.seed(4)
        x = np.random.randn(2,3,3,3)
        _x_ = Tensor(x,True)
        c3out = c3.forward_pass(_x_)
        c4out = c4.forward_pass(c3out)

        assert np.allclose(c3out.data, true_c3out)
        assert np.allclose(c4out.data, true_c4out)

    def test_conv2d_b(self):
        c3=Conv2D(n_filters=2, filter_shape=(3,3), stride=1, input_shape=(3,3,3), padding='same',seed=1)
        c4=Conv2D(n_filters=2, filter_shape=(3,3), stride=1,input_shape=c3.output_shape(), padding='same',seed=2)
        c3.initialize()
        c4.initialize()

        np.random.seed(4)
        x = np.random.randn(2,3,3,3)
        _x_ = Tensor(x,True)
        c3out = c3.forward_pass(_x_)
        c4out = c4.forward_pass(c3out)

        assert np.allclose(c3out.data, true_c3out)
        assert np.allclose(c4out.data, true_c4out)

        c4out.sum().backward()

        assert np.allclose(c3._x_ .grad.data, true_c3back)
        assert np.allclose(c4._x_ .grad.data, true_c4back)
        assert np.allclose(c3.w.grad.data, true_c3_wgrad)
        assert np.allclose(c4.w.grad.data, true_c4_wgrad)
        assert np.allclose(c3.b.grad.data, true_c3_bgrad)
        assert np.allclose(c4.b.grad.data, true_c4_bgrad)
